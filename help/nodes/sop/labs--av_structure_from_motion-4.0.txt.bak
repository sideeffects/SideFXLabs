= Labs AV Structure from Motions =

#type: node
#context: sop
#internal: labs::av_structure_from_motion::4.0
#icon: alicevision.png
#tags: sidefxlabs,  photogrammetry

""" Detects 3D points with position and orientation and calibrate the cameras accordingly using Alicevision. """

The objective of this step is to understand the geometric relationship behind all the observations provided by the input images, and infer the rigid scene structure (3D points) with the pose (position and orientation) and internal calibration of all cameras. The output of this node will be a point cloud.

@parameters
    == Main ==
    Cook:
        Start the cooking process for this step.
    Manual Mode:
        This toggle controls if the node should automatically recook if any dependencies have changed.
    Use Log:
        This toggle controls if the status of the current node should be printed to the console. This is useful for getting a quick overview of the progress.
    == Structure From Motion ==
    Describer Types:
        Describer types used to describe an image.
    Localizer Estimator:
        Estimator type used to localize cameras (acransac, ransac, lsmeds, loransac, maxconsensus).
    Max Num of Matches:
        Maximum number of matches per image pair (and per feature type).
        This can be useful to have a quick reconstruction overview. 0 means no limit.
    Inter File Extension:
        Extension of the intermediate file export.
    == Image Matching ==
    Min Number of Images:
        Minimal number of images to use the vocabulary tree. If we have less features than this threshold, we will compute all matching combinations.
    Max Descriptors:
        Limit the number of descriptors you load per image. Zero means no limit.
    Number of Matches:
        The number of matches to retrieve for each image (If 0 it will retrieve all the matches).
    Lock Scene Previously Reconstructed:
        This option is useful for SfM augmentation. Lock previously reconstructed poses and intrinsics.
    Local Bundle Adjustment:
        It reduces the reconstruction time, especially for large datasets (500+ images), by avoiding computation of the Bundle Adjustment on areas that are not changing.
    Use Only Inputfolder Matches:
        Use only matches from the input matchesFolder parameter. Matches folders previously added to the SfMData file will be ignored.
    Force Lock of All Intrinsic Camera Parameters:
        Force to keep constant all the intrinsics parameters of the cameras (focal length, principal point, distortion if any) during the reconstruction. This may be helpful if the input cameras are already fully calibrated.
    Use Rig Constraint:
        Enable/Disable rig constraint.
    Localizer Max Ransac Iterations:
        Maximum number of iterations allowed in ransac step.
    LocalBA Graph Distance:
        Graph-distance limit to define the Active region in the Local Bundle Adjustment strategy.
    Min Input Track Length:
        Minimum track length in input of SfM.
    Min Observation for Triangulation:
        Minimum number of observations to triangulate a point. Set it to 3 (or more) reduces drastically the noise in the point cloud, but the number of final poses is a little bit reduced (from 1.5% to 11% on the tested datasets).
    Min Angle for Triangulation:
        Minimum angle for triangulation.
    Localizer Max Ransac Error:
        Maximum error (in pixels) allowed for camera localization (resectioning). If set to 0, it will select a threshold according to the localizer estimator used (if ACRansac, it will analyze the input data to select the optimal value).
    Min Angle for Landmark:
        Minimum angle for landmark.
    Max Reprojection Error:
        Maximum reprojection error.
    Min Angle Initial Pair:
        Minimum angle for the initial pair.
    Max Angle Initial Pair:
        Maximum angle for the initial pair.
    == Prepare Dense Scene ==
    Output File Type:
        Output file type for the undistorted images.
    Save Metadata:
        Save projections and intrinsics information in images metadata (only for .exr images).
    Save Matrices Text Files:
        Save projections and intrinsics information in text files.
    Correct images exposure:
        Apply a correction on images Exposure Value.

    == Environment ==
     Environment:
	The environment used for launching the AliceVision utilities commandline. Note that this is a python expression and should be modified only through "Edit Expression".


@outputs
AV Depth Map:
    This plugs into AV Depth Map
Pointcloud:
    This is the pointcloud generated by the Prepare Dense Scene step.